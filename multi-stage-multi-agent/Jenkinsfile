stage('DB') {
    agent {
        docker {
            image 'mysql:8.0'
            args '-e MYSQL_ROOT_PASSWORD=rootpassword -e MYSQL_DATABASE=myapp -e MYSQL_USER=myuser -e MYSQL_PASSWORD=mypassword --health-cmd="mysqladmin ping -uroot -prootpassword" --health-interval=10s --health-timeout=5s --health-retries=10'
        }
    }
    steps {
        script {
            echo 'Waiting for MySQL to start...'
            // Increase to 60 attempts (3 minutes)
            for (int i = 1; i <= 60; i++) {
                try {
                    sh 'mysqladmin ping -uroot -prootpassword --silent'
                    echo "MySQL is ready after ${i} attempts"
                    break
                } catch (Exception e) {
                    echo "Waiting for MySQL to start... (attempt ${i}/60)"
                    sleep(3)
                }
            }
            sh 'mysql -uroot -prootpassword -e "SELECT version();"'
        }
    }
}
